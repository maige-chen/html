import{d as j,u as Q,r as D,a as _,c as T,o as g,b as f,e as W,f as X,U as M,g as K,h as Y,i as Z,j as ee,k as d,w as l,R as te,t as $,l as G,m as I,v as N,n as w,F as ne,p as ae,s as oe,q as re,x as S,y as le,S as se,z as O,A as ie,B as P}from"./main-BdkaI_ln.js";const B={blockSize:4*1024*1024,prefix:22,toString:function(m){const t=Array.from(m),n=String.fromCharCode.apply(null,t);return btoa(n).replace(/\//g,"_").replace(/\+/g,"-")},sha1:async function(m){const t=await window.crypto.subtle.digest("SHA-1",m);return new Uint8Array(t)},read:m=>new Promise(t=>{const n=new FileReader;n.onload=function(s){t(s.target?.result)},n.readAsArrayBuffer(m)}),eTag:async function(m){const t=await B.read(m),n=await B.sha1(t),s=new Uint8Array([B.prefix,...n]);return B.toString(s)}},ue={eTag:B.eTag};function ce(m,t,n){let s;const k=indexedDB.open(m);let a=new Promise((i,y)=>{k.onsuccess=function(u){s=u.target.result,i(s)},k.onupgradeneeded=function(u){s=u.target.result,i(s)},k.onerror=function(u){console.log(`打开indexedDB数据库:${m}出错!`),y()}});async function p(i){return i.objectStoreNames.contains(t)?i.transaction(t,"readwrite").objectStore(t):i.createObjectStore(t,{keyPath:n})}const v=async i=>{const y=await a,A=(await p(y)).get(i);return new Promise((R,V)=>{A.onsuccess=function(x){const z=x.target;R(z.result)},A.onerror=function(x){V(x.target.error)}})};function h(i){return s.transaction(t,"readwrite").objectStore(t).add(i)}return{get:v,add:h}}const de=j({__name:"LocalAvatar",setup(m){const t=Q(LSK.me,Empty.user);let n;t.value.id&&t.value.id.length>15&&(n=ce(t.value.id,"local_image","etag"),n.get(t.value.avatar).then(a=>{if(a===void 0)return;const p=URL.createObjectURL(a.image);s.value.push({url:p,isImage:!0})}));const s=D([]);function k(a){const p=a.file;ue.eTag(p).then(v=>{t.value.avatar=v,n.add({etag:v,image:p})})}return(a,p)=>{const v=_("van-uploader");return g(),T("div",null,[f(v,{modelValue:s.value,"onUpdate:modelValue":p[0]||(p[0]=h=>s.value=h),reupload:"","max-count":1,"after-read":k,style:{"--van-uploader-border-radius":"5px","--van-uploader-size":"70px"}},null,8,["modelValue"])])}}}),pe=m=>{const t="/u/profile",n={nickname:m};return W.put(t,n)},fe={key:0,class:"fs-5"},me={key:1,class:"input-group"},ge=j({__name:"Index",setup(m){const t=X(),n=M.getProfile(),s=D("");function k(){pe(s.value).then(r=>{r.avatar=n.avatar,r.t=n.t,M.cache(r,!1),window.location.reload()})}let a=t.$cApp;a.merchantId===""&&setTimeout(()=>{a=t.$cApp,h(),A()},1e3);const p=K({id:"",title:"精洗洗车",type:"CarwashFine"}),v=K({id:"",title:"普通洗车",type:"CarwashNormal"});function h(){a.merchantId!==""&&Y(a.merchantId).then(r=>{for(let e=0;e<r.length;e++){const c=r[e];c&&c.type==="CarwashFine"?(p.id=c.id,p.title=c.title):c&&c.type==="CarwashNormal"&&(v.id=c.id,v.title=c.title)}})}const i=D("");function y(r){if(i.value===""||i.value.length<4||i.value.length>5){oe("请输入车架后4位或车牌后5位");return}const e=r==="CarwashFine"?p.id:v.id,c=a.storeId,C={car:i.value,goodsId:e,storeId:c};re(C).then(U=>{u.value.unshift(U),i.value=""})}const u=D([]);function A(){a.merchantId!==""&&Z(a.merchantId).then(r=>{u.value=r})}function R(r,e){ie({title:"确定取消吗？"}).then(()=>{P(r,"Cancelled").then(c=>{u.value.splice(e,1)})}).catch(()=>{})}function V(r,e){P(r,"Cleaning").then(c=>{u.value[e]&&(u.value[e].state="Cleaning")})}function x(r,e){P(r,"Cleaned").then(c=>{u.value[e]&&(u.value[e].state="Cleaned")})}function z(r,e){P(r,"TookBack").then(c=>{u.value[e]&&(u.value[e].state="TookBack")})}function H(){localStorage.removeItem(LSK.carwashList),localStorage.removeItem(LSK.me),location.reload()}return ee(()=>{h(),A()}),(r,e)=>{const c=_("van-nav-bar"),C=_("van-col"),U=_("van-cell"),E=_("van-row"),b=_("van-button"),q=_("van-tag"),J=_("van-swipe-cell");return g(),T("div",null,[f(c,{title:d(t).$cApp?.appTitle,"right-text":"退出",onClickRight:H},null,8,["title"]),f(E,{class:"mt-5"},{default:l(()=>[f(C,{span:"8",class:"text-end"},{default:l(()=>[f(de)]),_:1}),f(C,{span:"16"},{default:l(()=>[f(U,{label:(d(t).$cApp.groupId==="0"?d(t).$cApp.storeTitle:d(t).$cApp.groupTitle)+": "+d(te)[d(t).$cApp.roles]},{title:l(()=>[d(n).nickname!=""?(g(),T("span",fe,$(d(n).nickname),1)):(g(),T("div",me,[G(I("input",{type:"text",class:"form-control","onUpdate:modelValue":e[0]||(e[0]=o=>s.value=o),placeholder:"请输入姓名"},null,512),[[N,s.value]]),I("button",{class:"btn btn-primary",type:"button",onClick:k},"保存")]))]),_:1},8,["label"])]),_:1})]),_:1}),f(E,{gutter:"20",class:"p-2 mt-4 mb-2"},{default:l(()=>[f(C,{span:"24"},{default:l(()=>[G(I("input",{type:"text",class:"form-control mb-2","onUpdate:modelValue":e[1]||(e[1]=o=>i.value=o),placeholder:"车架后4位 或 车牌后5位"},null,512),[[N,i.value]])]),_:1}),f(C,{span:"12"},{default:l(()=>[f(b,{type:"default",size:"small",block:"",onClick:e[2]||(e[2]=o=>y(v.type))},{default:l(()=>[w($(v.title),1)]),_:1})]),_:1}),f(C,{span:"12"},{default:l(()=>[f(b,{type:"success",size:"small",block:"",onClick:e[3]||(e[3]=o=>y(p.type))},{default:l(()=>[w($(p.title),1)]),_:1})]),_:1})]),_:1}),(g(!0),T(ne,null,ae(u.value,(o,L)=>(g(),S(J,{key:o.id},le({default:l(()=>[f(U,{"is-link":"",center:"",title:o.id+"."+d(se)[o.state],"title-style":"flex-basis:160px; flex-grow: 1 !important"},{label:l(()=>[o.goodsFlag===1?(g(),S(q,{key:0,type:"primary",class:"ms-1"},{default:l(()=>[...e[4]||(e[4]=[w("精细洗车",-1)])]),_:1})):(g(),S(q,{key:1,class:"ms-1"},{default:l(()=>[...e[5]||(e[5]=[w("普通洗",-1)])]),_:1})),I("span",null,$(o.car)+": "+$(o.createdAt),1),e[6]||(e[6]=I("br",null,null,-1))]),value:l(()=>[o.state==="Placed"&&(d(a).roles==="StoreManager"||d(a).roles==="StoreClerk")?(g(),S(b,{key:0,type:"primary",size:"small",onClick:F=>V(o.id,L)},{default:l(()=>[...e[7]||(e[7]=[w(" 接单 ",-1)])]),_:1},8,["onClick"])):O("",!0),o.state==="Cleaning"&&(d(a).roles==="StoreManager"||d(a).roles==="StoreClerk")?(g(),S(b,{key:1,type:"primary",size:"small",onClick:F=>x(o.id,L)},{default:l(()=>[...e[8]||(e[8]=[w(" 完成 ",-1)])]),_:1},8,["onClick"])):O("",!0),o.state==="Cleaned"&&(d(a).roles==="S4Supervisor"||d(a).roles==="S4Employee")?(g(),S(b,{key:2,type:"primary",size:"small",onClick:F=>z(o.id,L)},{default:l(()=>[...e[9]||(e[9]=[w(" 提车 ",-1)])]),_:1},8,["onClick"])):O("",!0)]),_:2},1032,["title"])]),_:2},[o.state==="Placed"&&o.userId===d(n).id?{name:"right",fn:l(()=>[f(b,{square:"",type:"danger",text:"取消",onClick:F=>R(o.id,L),class:"h-100"},null,8,["onClick"])]),key:"0"}:void 0]),1024))),128))])}}});export{ge as default};
